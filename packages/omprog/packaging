set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# Detect # of CPUs so make jobs can be parallelized
CPUS=$(grep -c ^processor /proc/cpuinfo)
 # Available variables
# $BOSH_COMPILE_TARGET - where this package & spec'd source files are available
# $BOSH_INSTALL_TARGET - where you copy/install files to be included in package
export HOME=/var/vcap

export PREFIX=${BOSH_INSTALL_TARGET}
export PATH=$PREFIX/bin:$PATH
export CPPFLAGS="-I${BOSH_INSTALL_TARGET}/include"
export LDFLAGS="-L${BOSH_INSTALL_TARGET}/lib"
export LIBRARY_PATH="${BOSH_INSTALL_TARGET}/lib"
export LD_LIBRARY_PATH="${LIBRARY_PATH}"
export CFLAGS="-fPIC"

export PKG_CONFIG_PATH=/var/vcap/packages/omprog/lib/pkgconfig

function install {
  (
    set -e
    cd $1
    ./configure --prefix=${BOSH_INSTALL_TARGET} ${2-}
    make -j${CPUS}
    make install
  )
}

# Install snort and dependencies
tar xf autoconf-2.69.tar.gz && install autoconf-2.69
tar xf automake-1.15.tar.gz && install automake-1.15
tar xf libtool-2.4.6.tar.gz && install libtool-2.4.6
tar xf json-c-0.12.1.tar.gz && install json-c-0.12.1
tar xf libuuid-1.0.3.tar.gz && install libuuid-1.0.3
tar xf libestr-0.1.10.tar.gz && install libestr-0.1.10
tar xf pkg-config-0.28.tar.gz && install pkg-config-0.28 --with-internal-glib
tar xf Python-2.7.10.tgz && install Python-2.7.10

tar xf docutils-0.12.tar.gz
(
  set -i
  cd docutils-0.12
  python setup.py install
  ln -s $(which rst2man.py) $BOSH_INSTALL_TARGET/bin/rst2man
)

tar xzf rsyslog-7.4.6.tar.gz
(
  set -e
  cd rsyslog-7.4.6
  autoreconf -fvi
  ./configure --prefix=${BOSH_INSTALL_TARGET}
  cd plugins/omprog
  make && make install
)
